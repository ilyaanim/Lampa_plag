# Project Architecture: Lampa Wide Covers Plugin

## Overview
Plugin for Lampa.mx that changes the Full Detail View (movie page) layout:
- Wide backdrop image (original quality, up to 4K) with gradient overlay
- Movie info (title/logo, ratings, buttons) overlaid on the image
- Netflix-style cinematic layout
- TMDB logo instead of text title (English preferred)
- Average rating badge (from TMDB, IMDB, KP)
- Top 3 cast member cards next to description
- Date/country badge on poster (next to TV badge)

## Files
- `wide_covers.js` — Wide covers plugin (cinematic Full Detail View layout)
- `new_main_menu.js` — Main menu plugin (reorganizes Главная page sections)
- `project_architecture` — This file, project documentation
- `README.md` — Installation and usage instructions

## New Main Menu Plugin (new_main_menu.js)

### Target: Главная (Main) page
Reorganizes sections on the main page:
- Shows only "Продолжить просмотр" (Continue watching) and "Позже" (Watch later)
- All other sections (trending, popular, genres, etc.) are hidden

### How it works:
1. **Register "Позже" section** via `Lampa.ContentRows.add()` at index 2
   - Fetches items from `Lampa.Favorite.get({type: 'wath'})` (Watch later bookmarks)
   - Displays up to 20 cards
2. **Hide unwanted sections** — finds all `.items-line` elements, checks title text
   - Allowed titles (partial match): "Продолжить", "Позже", "Continue", "Watch later"
   - Everything else gets `display: none`
3. **Async handling** — sections load asynchronously from TMDB API, so:
   - Retry loop (30 attempts × 500ms = 15 sec) on page load
   - MutationObserver on `.scroll__body` catches late-loading sections
   - Processes on both `activity:start` and `activity:complite` events
4. **Page detection** — only runs when `Lampa.Activity.active().component === 'main'`
   - Observer disconnects when navigating away from Главная

### Lampa internals used:
- `Lampa.ContentRows.add()` — register custom section on main/category screens
- `Lampa.Favorite.get({type: 'wath'})` — get Watch Later bookmarks
- `Lampa.Activity.active()` — check current page (component === 'main')
- `Lampa.Listener.follow('activity', ...)` — listen for page navigation
- `Lampa.Listener.follow('app', ...)` — wait for app ready

### DOM structure (Главная):
```
.scroll__body
  .items-line                          ← section container
    .items-line__title                 ← section title text
    .items-line__body
      .items-cards.mapping--line       ← horizontal scroll with cards
  .items-line                          ← next section
    ...
```

## Plugin Structure (wide_covers.js)

### Target: Full Detail View page
Original layout: `.full-start-new__body` is flex horizontal
- Left: `.full-start-new__left` (17em, portrait poster 2:3)
- Right: `.full-start-new__right` (title, ratings, buttons)

Plugin changes to cinematic vertical layout:
- Wide backdrop (50% aspect ratio) with gradient fade (mask-image)
- Text overlaid on poster via negative margin (-30em)
- 10% black gradient overlay on left side for text readability
- Background backdrop blurred and darkened (blur 20px, brightness 0.4)
- Reactions hidden, button labels collapsed (except Play)
- TMDB logo replaces text title (English preferred, fallback to any)
- Date/country info moved to poster (next to TV badge)
- Genres removed from details line
- Average rating from TMDB/IMDB/KP with rounded star icon
- Seasons/episodes merged into rating line
- "Подробно" section title hidden
- Smaller description font with 3 circular actor cards to the right

### Sections:
1. **CSS Injection** (immediate, with !important)
   - `.full-start-new__body` → `flex-direction: column`
   - `.full-start-new__left` → `width: 100%`
   - `.full-start-new__poster` → `padding-bottom: 50%`, rounded top corners (2em)
   - `.full-start-new__poster::before` → 10% black left gradient overlay
   - `.full-start-new__poster .full-start-new__img` → `mask-image` gradient fade
   - `.full-start-new__right` → `margin-top: -30em; z-index: 2`
   - `.full-start__background` → `blur(20px) brightness(0.4)`
   - `.full-start-new__reactions` → `display: none`
   - `.full-start-new__buttons .button--play span` → visible
   - Other button spans → hidden (icon-only)
   - `.wide-poster-info` → flex badge+date on poster
   - `.wide-logo` → TMDB logo (max 35rem × 12rem)
   - `.wide-avg-rate` → average rating badge with SVG star
   - `.wide-descr-row` → flex container for description + cast
   - `.wide-cast` → 3 circular actor cards

2. **Image Swap** — `swapPoster()`:
   - Preserves proxy prefix (`imagetmdb.com`) and query params (`?email=...`)
   - Replaces size (`w500` → `original`) and path (`poster_path` → `backdrop_path`)
   - Fallback chain: `original` → `w1280`

3. **Buttons Reorder** — `moveButtonsBlock()`:
   - Moves `.full-start-new__buttons` block above `.full-start-new__reactions`

4. **Head to Poster** — `moveHeadToPoster()`:
   - Creates `.wide-poster-info` on poster with TV badge + date/country text

5. **Genres Removal** — `removeGenresFromDetails()`:
   - Removes genre spans (containing `|` but not `:`) from details

6. **Rating Merge** — `mergeRatings()`:
   - Calculates average from TMDB/IMDB/KP ratings
   - Creates `.wide-avg-rate` badge with rounded SVG star
   - Merges seasons/episodes info into rating line
   - Adds quality badges (4K/1080p/Low) and duration

6a. **Next Episode Info** — `moveNextEpisodeInfo()`:
   - Extracts "Следующая серия" / "Осталось дней" from rate-line
   - Creates `.wide-next-info` block above rate-line
   - `retryNextEpisode()` re-checks at 1s, 3s, 5s for async-loaded data

7. **Logo Display** — `fetchAndSetLogo()`:
   - Fetches logos from TMDB `/images` endpoint (English priority)
   - Replaces title text with `<img>` logo

8. **Cast Display** — `fetchAndShowCast()`:
   - Fetches `/credits` from TMDB, shows top 3 actors with photos
   - Circular avatar cards with names, placed right of description

9. **Movie Data Access** — `getMovie()`:
    - Primary: `Lampa.Activity.active().card`
    - Fallbacks: `act.params.movie`, `act.movie`, `act.data.movie`

10. **Event Hooks** — `Lampa.Listener.follow('full', ...)` + `('activity', ...)`
    - Runs `trySwap()` on `full:complite` and `activity:start`
    - Retry: up to 30 attempts at 150ms intervals

### Lampa DOM structure (full detail view):
```
.full-start-new
  .full-start-new__body
    .full-start-new__left
      .full-start-new__poster > img.full--poster
        .wide-poster-info (injected: TV badge + date/country)
    .full-start-new__right
      .full-start-new__title (replaced with .wide-logo if available)
      .full-start-new__tagline
      .full-start-new__rate-line (.wide-avg-rate + seasons/episodes)
      .full-start-new__details (hidden after merge)
      .full-start-new__buttons     ← moved above reactions
      .full-start-new__reactions   ← hidden via CSS
  .items-line (description section)
    .wide-descr-row
      .full-descr (description text)
      .wide-cast (3 actor cards)
```

### Key Lampa internals:
- Image proxy: `imagetmdb.com` (not direct `image.tmdb.org`)
- URL format: `http://imagetmdb.com/t/p/{size}/{path}?email=...`
- Activity API: `Lampa.Activity.active()` → `{card: {backdrop_path, poster_path, ...}}`
- Events: `Lampa.Listener.follow('full', fn)` with `e.type === 'complite'`
- TMDB API key: `Lampa.TMDB.key()` or hardcoded fallback
